# $NetBSD: Makefile,v 1.170 2025/02/08 03:33:12 taca Exp $

DISTNAME=	phpMyAdmin-4.9.10-all-languages
PKGNAME=	${PHP_PKG_PREFIX}-${DISTNAME:S/-all-languages//:tl}
PKGREVISION=	1
CATEGORIES=	databases www
MASTER_SITES=	https://files.phpmyadmin.net/phpMyAdmin/${PKGVERSION_NOREV}/
EXTRACT_SUFX=	.tar.xz

MAINTAINER=	tm@NetBSD.org
HOMEPAGE=	https://www.phpmyadmin.net/
COMMENT=	Set of PHP-scripts to adminstrate MySQL over the WWW
LICENSE=	gnu-gpl-v2

DEPENDS+=	${PHP_PKG_PREFIX}-bz2>=${PHP_BASE_VERS}:../../archivers/php-bz2
DEPENDS+=	${PHP_PKG_PREFIX}-zip>=${PHP_BASE_VERS}:../../archivers/php-zip
DEPENDS+=	${PHP_PKG_PREFIX}-zlib>=${PHP_BASE_VERS}:../../archivers/php-zlib
DEPENDS+=	${PHP_PKG_PREFIX}-mbstring>=${PHP_BASE_VERS}:../../converters/php-mbstring
DEPENDS+=	${PHP_PKG_PREFIX}-gettext>=${PHP_BASE_VERS}:../../devel/php-gettext
DEPENDS+=	${PHP_PKG_PREFIX}-mysqli>=${PHP_BASE_VERS}:../../databases/php-mysqli
DEPENDS+=	${PHP_PKG_PREFIX}-gd>=${PHP_BASE_VERS}:../../graphics/php-gd

USE_LANGUAGES=	# none
USE_TOOLS+=	pax

APACHE_USER?=	www
APACHE_GROUP?=	www

PKG_GROUPS=	${APACHE_GROUP}
PKG_USERS=	${APACHE_USER}:${APACHE_GROUP}
BUILD_DEFS+=	APACHE_USER APACHE_GROUP VARBASE

PKG_USERS_VARS=		APACHE_USER
PKG_GROUPS_VARS=	APACHE_GROUP

PKG_SYSCONFSUBDIR=	phpmyadmin

FILES_SUBST+=	APACHE_GROUP=${APACHE_GROUP} APACHE_USER=${APACHE_USER}
FILES_SUBST+=	PMCONFDIR=${PMCONFDIR} PMVARDIR=${PMVARDIR}
MESSAGE_SUBST+=	PMCONFDIR=${PMCONFDIR} PMCONFFILE=${PMCONFFILE}

DOC_FILES=	ChangeLog CONTRIBUTING.md LICENSE \
		README RELEASE-DATE-${PKGVERSION_NOREV}

EXDIR=		${PREFIX}/share/examples/phpmyadmin
PMCONFDIR=	${PKG_SYSCONFDIR}
PMCONFFILE=	${PKG_SYSCONFDIR}/config.inc.php
PMDIR=		${PREFIX}/share/phpmyadmin
PMVARDIR=	${VARBASE}/phpmyadmin

REPLACE_PHP+=	vendor/phpmyadmin/sql-parser/bin/highlight-query
REPLACE_PHP+=	vendor/bin/highlight-query
REPLACE_PHP+=	vendor/phpmyadmin/sql-parser/bin/lint-query
REPLACE_PHP+=	vendor/bin/lint-query
REPLACE_PHP+=	vendor/phpmyadmin/sql-parser/bin/tokenize-query
REPLACE_PHP+=	vendor/bin/tokenize-query

REPLACE_SH+=	vendor/twig/twig/drupal_test.sh

CONF_FILES+=	${EXDIR}/apache.conf ${PKG_SYSCONFDIR}/apache.conf

SRCS=		*.css *.ico *.php *.txt doc js libraries locale setup \
		sql templates themes vendor

NO_BUILD=		yes

SUBST_CLASSES+=		paths
SUBST_FILES.paths+=	${WRKDIR}/phpmyadmin.conf
SUBST_FILES.paths+=	libraries/vendor_config.php
SUBST_VARS.paths=	PMDIR
SUBST_VARS.paths+=	PMVARDIR
SUBST_SED.paths+=	-e "s|@PMCONFDIR@|${PMCONFDIR}/|g"
SUBST_STAGE.paths=	post-configure

INSTALLATION_DIRS+=	${PREFIX}/share/doc/phpmyadmin \
			${PREFIX}/share/examples/phpmyadmin

.include "../../lang/php/phpversion.mk"

.if ${PHP_VER} < 71
DEPENDS+=	${PHP_PKG_PREFIX}-mcrypt>=${PHP_BASE_VERS}:../../security/php-mcrypt
.else
DEPENDS+=	${PHP_PKG_PREFIX}-pecl-mcrypt>=1.0.1:../../security/php-pecl-mcrypt
.endif

post-extract:
	${CP} ${FILESDIR}/phpmyadmin.conf ${WRKDIR}

do-install:
	${RM} -f ${WRKSRC}/libraries/vendor_config.php.orig
	cd ${WRKSRC} && pax -rw ${SRCS} ${DESTDIR}${PMDIR}
	${INSTALL_DATA} ${WRKSRC}/config.sample.inc.php ${DESTDIR}${EXDIR}
	${INSTALL_DATA} ${WRKSRC}/examples/* ${DESTDIR}${EXDIR}
	${LN} -fs ${EXDIR} ${DESTDIR}${PMDIR}/examples
	cd ${WRKSRC} && \
		${INSTALL_DATA} ${DOC_FILES} \
			${DESTDIR}${PREFIX}/share/doc/phpmyadmin
	${INSTALL_DATA} ${WRKDIR}/phpmyadmin.conf ${DESTDIR}${EXDIR}/apache.conf

.include "../../lang/php/json.mk"
.include "../../mk/bsd.pkg.mk"
